<h3>Inspection Report</h3>

<form #reportForm="ngForm" (ngSubmit)="submitReport()" novalidate>

    <!-- Product & Stage -->
    <div class="row mt-3">

        <!-- Product -->
        <div class="col">
            <select class="form-select" name="productId" [(ngModel)]="productId" required (change)="loadPlan()"
                #productRef="ngModel" [ngClass]="{'is-invalid': productRef.invalid && productRef.touched}">
                <option value="">Select Product</option>
                <option *ngFor="let p of products" [value]="p._id">{{p.name}}</option>
            </select>
            <div class="text-danger small" *ngIf="productRef.invalid && productRef.touched">
                Product selection is required.
            </div>
        </div>

        <!-- Stage -->
        <div class="col">
            <select class="form-select" name="stage" [(ngModel)]="stage" required (change)="loadPlan()"
                #stageRef="ngModel" [ngClass]="{'is-invalid': stageRef.invalid && stageRef.touched}">
                <option value="in-process">In-Process</option>
                <option value="final">Final</option>
            </select>
            <div class="text-danger small" *ngIf="stageRef.invalid && stageRef.touched">
                Stage selection is required.
            </div>
        </div>
    </div>

    <!-- Dynamic Parameter Cards -->
    <div *ngFor="let e of entries; let i=index" class="card p-3 mt-3">

        <h5 class="mb-2">{{plans[i].parameterId.name}}</h5>

        <!-- Observations -->
        <div class="row">
            <div class="col" *ngFor="let x of e.observations; let j=index">

                <input class="form-control" type="number" placeholder="Obs {{j+1}}" name="obs{{i}}{{j}}"
                    [(ngModel)]="e.observations[j]" required #obsRef="ngModel"
                    [ngClass]="{'is-invalid': obsRef.invalid && obsRef.touched}">

                <div class="text-danger small" *ngIf="obsRef.invalid && obsRef.touched">
                    Observation {{j+1}} is required.
                </div>

                <!-- Check range validation -->
                <div class="text-danger small" *ngIf="
            e.observations[j] !== '' &&
            (e.observations[j] < plans[i].parameterId.lowerLimit ||
             e.observations[j] > plans[i].parameterId.upperLimit)
          ">
                    Value must be between {{plans[i].parameterId.lowerLimit}} and {{plans[i].parameterId.upperLimit}}
                </div>

            </div>
        </div>

        <!-- Remarks -->
        <textarea class="form-control mt-2" placeholder="Remarks" name="remarks{{i}}" [(ngModel)]="e.remarks" required
            minlength="3" #remarksRef="ngModel"
            [ngClass]="{'is-invalid': remarksRef.invalid && remarksRef.touched}"></textarea>

        <div class="text-danger small" *ngIf="remarksRef.invalid && remarksRef.touched">
            Remarks are required (min 3 characters).
        </div>

    </div>

    <!-- Submit Button -->
    <button class="btn btn-success mt-4" [disabled]="reportForm.invalid">
        Submit
    </button>

</form>